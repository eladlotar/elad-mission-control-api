<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ELAD CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --blue: #1877f2;
      --blue-dark: #0f5bb5;
      --bg: #f3f4f6;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #ef4444;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    /* Layout */

    .login-wrapper {
      max-width: 380px;
      margin: 80px auto;
      padding: 24px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    .login-title {
      font-size: 20px;
      margin-bottom: 4px;
      font-weight: 600;
      text-align: center;
    }

    .login-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 16px;
    }

    label {
      font-size: 14px;
      display: block;
      margin-bottom: 4px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      margin-bottom: 10px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 1px rgba(24, 119, 242, 0.2);
    }

    button {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-primary {
      background: var(--blue);
      color: white;
    }

    .btn-primary:hover {
      background: var(--blue-dark);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      background: #e5e7eb;
    }

    .error-msg {
      color: var(--danger);
      font-size: 13px;
      min-height: 16px;
      margin-top: 4px;
    }

    .success-msg {
      color: var(--success);
      font-size: 13px;
      min-height: 16px;
      margin-top: 4px;
    }

    /* App layout */

    .app-layout {
      display: none;
      height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      font-size: 16px;
      color: var(--blue-dark);
    }

    .sidebar-user {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      color: var(--text-muted);
    }

    .sidebar-nav {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0 16px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      padding: 8px 16px 4px;
    }

    .nav-item {
      padding: 8px 16px;
      font-size: 14px;
      color: #374151;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav-item span {
      flex: 1;
    }

    .nav-item:hover {
      background: #f3f4f6;
      cursor: pointer;
    }

    .nav-item.active {
      background: #eff6ff;
      color: var(--blue-dark);
      font-weight: 600;
      border-right: 3px solid var(--blue);
    }

    .nav-item-sub {
      padding-right: 32px;
    }

    .sidebar-footer {
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
      color: var(--text-muted);
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .main-header {
      height: 56px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
    }

    .main-header-title {
      font-size: 18px;
      font-weight: 600;
    }

    .main-header-actions {
      font-size: 13px;
      color: var(--text-muted);
    }

    .main-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    /* Dashboard */

    .cards-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
    }

    .card-title {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .card-value {
      font-size: 20px;
      font-weight: 600;
    }

    .card-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1.2fr 1.8fr;
      gap: 12px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .small-text {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Tables */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      text-align: right;
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f9fafb;
      color: #4b5563;
      font-weight: 600;
      font-size: 12px;
    }

    tr:hover td {
      background: #f9fafb;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: var(--blue-dark);
    }

    .status-lead {
      background: #fef3c7;
      color: #92400e;
    }

    .status-active {
      background: #dcfce7;
      color: #166534;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
    }

    .flex {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .mt-8 {
      margin-top: 8px;
    }

    .mt-12 {
      margin-top: 12px;
    }

    .mb-8 {
      margin-bottom: 8px;
    }

    .mb-4 {
      margin-bottom: 4px;
    }

    .input-inline {
      max-width: 220px;
    }

    .section-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Responsive */

    @media (max-width: 900px) {
      .app-layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        border-left: none;
        border-bottom: 1px solid #e5e7eb;
      }

      .main {
        height: calc(100vh - 140px);
      }

      .cards-row {
        grid-template-columns: 1fr;
      }

      .two-column {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- מסך לוגין -->
  <div id="login-wrapper" class="login-wrapper">
    <div class="login-title">ELAD CRM</div>
    <div class="login-subtitle">כניסה למערכת הניהול</div>
    <div>
      <label for="login-email">אימייל</label>
      <input
        type="email"
        id="login-email"
        placeholder="admin@crm.local"
        autocomplete="username"
      />
    </div>
    <div>
      <label for="login-password">סיסמה</label>
      <input
        type="password"
        id="login-password"
        placeholder="Admin1234!"
        autocomplete="current-password"
      />
    </div>
    <button id="login-btn" class="btn-primary" style="width: 100%; margin-top: 4px;">
      התחברות
    </button>
    <div id="login-error" class="error-msg"></div>
  </div>

  <!-- אפליקציה -->
  <div id="app-layout" class="app-layout">
    <aside class="sidebar">
      <div class="sidebar-header">ELAD CRM</div>
      <div id="sidebar-user" class="sidebar-user">לא מחובר</div>
      <div class="sidebar-nav">
        <div class="nav-section-title">ראשי</div>
        <div class="nav-item active" data-section="dashboard">
          <span>מסך בית</span>
        </div>
        <div class="nav-item" data-section="calendar">
  <span>יומן / לוח שנה</span>
</div>

        <div class="nav-section-title">לקוחות</div>
        <div class="nav-item" data-section="leads">
          <span>מתעניינים / לידים</span>
        </div>
        <div class="nav-item" data-section="customers">
          <span>לקוחות קיימים</span>
        </div>

        <div class="nav-section-title">כספים</div>
        <div class="nav-item" data-section="billing">
          <span>סליקה (בהכנה)</span>
        </div>
        <div class="nav-item nav-item-sub" data-section="income">
          <span>הנהלת חשבונות – הכנסות</span>
        </div>
        <div class="nav-item nav-item-sub" data-section="expenses">
          <span>הנהלת חשבונות – הוצאות</span>
        </div>
        <div class="nav-item nav-item-sub" data-section="payroll">
          <span>שכר (בהמשך)</span>
        </div>

        <div class="nav-section-title">תפעול</div>
        <div class="nav-item" data-section="tasks">
          <span>משימות</span>
        </div>
        <div class="nav-item" data-section="products">
          <span>מוצרים / מלאי</span>
        </div>
        <div class="nav-item" data-section="sales">
          <span>ניהול מכירות (שיחות)</span>
        </div>
        <div class="nav-item" data-section="automations">
          <span>אוטומציות (וואטסאפ / מייל / SMS)</span>
        </div>

        <div class="nav-section-title">מערכת</div>
        <div class="nav-item" data-section="settings">
          <span>הגדרות והרשאות</span>
        </div>
      </div>
      <div class="sidebar-footer">
        גרסה ראשונית – מחשב<br />
        התאמה לאפליקציה תבוא אחרי זה.
      </div>
    </aside>

    <div class="main">
      <div class="main-header">
        <div class="main-header-title" id="main-title">מסך בית</div>
        <div class="main-header-actions" id="main-subtitle"></div>
      </div>
      <div class="main-content">
        <!-- Dashboard -->
        <div id="section-dashboard">
          <div class="cards-row">
            <div class="card">
              <div class="card-title">לידים חדשים היום</div>
              <div id="dash-new-leads" class="card-value">0</div>
              <div class="card-sub" id="dash-new-leads-sub"></div>
            </div>
            <div class="card">
              <div class="card-title">הכנסות החודש (₪)</div>
              <div id="dash-income" class="card-value">0</div>
              <div class="card-sub" id="dash-income-sub"></div>
            </div>
            <div class="card">
              <div class="card-title">אחוז המרה (לידים → לקוחות פעילים)</div>
              <div id="dash-conversion" class="card-value">0%</div>
              <div class="card-sub" id="dash-conversion-sub"></div>
            </div>
          </div>

          <div class="two-column">
            <div class="card">
              <div class="section-title">משימות היום</div>
              <div class="small-text">גרסה ראשונית – משימות בסיסיות בלבד.</div>
              <div id="dash-tasks-list" class="mt-8 small-text">
                אין כרגע משימות להצגה.
              </div>
            </div>

            <div class="card">
              <div class="section-title">לידים חמים (48 שעות אחרונות)</div>
              <div class="small-text">
                לידים שנכנסו ב־48 השעות האחרונות ולא הפכו עדיין ללקוחות פעילים.
              </div>
              <div id="dash-hot-leads" class="mt-8 small-text">
                אין כרגע לידים חמים.
              </div>
            </div>
          </div>
        </div>

        <!-- Leads -->
        <div id="section-leads" style="display: none;">
          <div class="flex-between mb-8">
            <div class="section-title">מתעניינים / לידים</div>
            <div class="flex">
              <input
                id="leads-search"
                class="input-inline"
                placeholder="חיפוש לפי שם / טלפון / מייל"
              />
              <button id="leads-search-btn" class="btn-ghost">חיפוש</button>
            </div>
          </div>

          <div class="two-column">
            <div class="card">
              <div class="section-title">הוספת ליד חדש</div>
              <label>שם מלא</label>
              <input id="lead-name" />

              <label>טלפון</label>
              <input id="lead-phone" />

              <label>אימייל</label>
              <input id="lead-email" />

              <label>מקור (קמפיין / המלצה / אורגני)</label>
              <input id="lead-source" />

              <label>הערות</label>
              <textarea id="lead-notes" rows="3"></textarea>

              <button id="lead-save-btn" class="btn-primary" style="margin-top: 4px;">
                שמירת ליד
              </button>
              <div id="lead-save-msg" class="section-note"></div>
            </div>

            <div class="card">
              <div class="flex-between mb-4">
                <div class="section-title">לידים פתוחים</div>
              </div>
              <div class="section-note">
                לידים בסטטוס LEAD מתוך המערכת. שינוי סטטוס ללקוח פעיל יעביר אותם
                למסך "לקוחות קיימים".
              </div>
              <div class="mt-8" style="max-height: 380px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>שם</th>
                      <th>טלפון</th>
                      <th>סטטוס</th>
                      <th>מקור</th>
                    </tr>
                  </thead>
                  <tbody id="leads-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Customers -->
        <div id="section-customers" style="display: none;">
          <div class="flex-between mb-8">
            <div class="section-title">לקוחות קיימים</div>
            <div class="flex">
              <input
                id="customers-search"
                class="input-inline"
                placeholder="חיפוש לפי שם / טלפון / מייל"
              />
              <button id="customers-search-btn" class="btn-ghost">חיפוש</button>
            </div>
          </div>

          <div class="card">
            <div class="section-note">
              לקוחות שהסטטוס שלהם במערכת הוא ACTIVE. ניתן לשנות סטטוס גם דרך API או
              ניהול ידני בהמשך.
            </div>
            <div class="mt-8" style="max-height: 430px; overflow-y: auto;">
              <table>
                <thead>
                  <tr>
                    <th>שם</th>
                    <th>טלפון</th>
                    <th>מייל</th>
                    <th>סטטוס</th>
                  </tr>
                </thead>
                <tbody id="customers-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- פלייסהולדרים לשאר המסכים -->
        <div id="section-billing" style="display: none;">
          <div class="card">
            <div class="section-title">סליקה – בהכנה</div>
            <div class="small-text">
              כאן תופיע בעתיד אפשרות לחיבור חברת סליקה (API), צפייה בחיובים וקישור
              להכנסות במערכת.
            </div>
          </div>
        </div>

        <div id="section-income" style="display: none;">
          <div class="card">
            <div class="section-title">הנהלת חשבונות – הכנסות</div>
            <div class="small-text">
              הנתונים נשלפים מ־/api/payments (ADMIN / ACCOUNTANT בלבד). זה ייבנה
              בהמשך על בסיס המודול הקיים בשרת.
            </div>
          </div>
        </div>

        <div id="section-expenses" style="display: none;">
          <div class="card">
            <div class="section-title">הנהלת חשבונות – הוצאות</div>
            <div class="small-text">
              כאן תהיה אפשרות להעלות קבצים (חשבוניות / תמונות) לפי חודשים, לשימוש
              רואה החשבון. זה פלייסהולדר מוכן להמשך פיתוח.
            </div>
          </div>
        </div>

        <div id="section-payroll" style="display: none;">
          <div class="card">
            <div class="section-title">שכר – בהמשך</div>
            <div class="small-text">
              מודול שכר עם חישוב גלובלי / בסיס / עמלות ושעות ייבנה על גבי הנתונים
              שכבר סגרנו. כרגע זה מקום שמור.
            </div>
          </div>
        </div>

        <div id="section-tasks" style="display: none;">
          <div class="card">
            <div class="section-title">משימות – גרסה בסיסית בהמשך</div>
            <div class="small-text">
              משימות יתחברו ל־/api/tasks – לידים, לקוחות, תזכורות follow-up. כרגע
              זה אזור פלייסהולדר.
            </div>
          </div>
        </div>

        <div id="section-products" style="display: none;">
          <div class="card">
            <div class="section-title">מוצרים / מלאי</div>
            <div class="small-text">
              כאן יהיה ניהול מלאי, מוצרים, מחירים, ברקודים ודוחות מכירה. אפשר
              להרחיב בשלב הבא.
            </div>
          </div>
        </div>

        <div id="section-sales" style="display: none;">
          <div class="card">
            <div class="section-title">ניהול מכירות (שיחות)</div>
            <div class="small-text">
              מסך ייעודי לניהול שיחות מכירה וחיבור למערכות טלפוניה יתווסף בשלב
              מאוחר יותר.
            </div>
          </div>
        </div>

        <div id="section-automations" style="display: none;">
          <div class="card">
            <div class="section-title">אוטומציות</div>
            <div class="small-text">
              כאן תופיע תצורת חיבור לאוטומציות (וואטסאפ, מייל, SMS) בשילוב
              אינטגרציות חיצוניות.
            </div>
          </div>
        </div>

        <div id="section-settings" style="display: none;">
          <div class="card">
            <div class="section-title">הגדרות והרשאות</div>
            <div class="small-text">
              ניהול משתמשים, הרשאות, מחירים ופרמטרים של המערכת ייכנס לכאן. כרגע
              זה מסך הכנה.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiBase = ''; // אותו דומיין
    let token = null;
    let currentUser = null;

    const loginWrapper = document.getElementById('login-wrapper');
    const appLayout = document.getElementById('app-layout');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    const sidebarUser = document.getElementById('sidebar-user');
    const mainTitle = document.getElementById('main-title');
    const mainSubtitle = document.getElementById('main-subtitle');

    const navItems = document.querySelectorAll('.nav-item');

    const sections = {
      dashboard: document.getElementById('section-dashboard'),
      leads: document.getElementById('section-leads'),
      customers: document.getElementById('section-customers'),
      billing: document.getElementById('section-billing'),
      income: document.getElementById('section-income'),
      expenses: document.getElementById('section-expenses'),
      payroll: document.getElementById('section-payroll'),
      tasks: document.getElementById('section-tasks'),
      products: document.getElementById('section-products'),
      sales: document.getElementById('section-sales'),
      automations: document.getElementById('section-automations'),
      settings: document.getElementById('section-settings'),
    };

    function showSection(sectionName) {
      Object.keys(sections).forEach((key) => {
        sections[key].style.display = key === sectionName ? 'block' : 'none';
      });

      navItems.forEach((item) => {
        const sec = item.getAttribute('data-section');
        if (sec === sectionName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      switch (sectionName) {
        case 'dashboard':
          mainTitle.textContent = 'מסך בית';
          mainSubtitle.textContent = 'תמונה כללית על העסק';
          loadDashboard();
          break;
        case 'leads':
          mainTitle.textContent = 'מתעניינים / לידים';
          mainSubtitle.textContent = '';
          loadLeads();
          break;
        case 'customers':
          mainTitle.textContent = 'לקוחות קיימים';
          mainSubtitle.textContent = '';
          loadCustomers();
          break;
        case 'billing':
          mainTitle.textContent = 'סליקה (בהכנה)';
          mainSubtitle.textContent = '';
          break;
        case 'income':
          mainTitle.textContent = 'הנהלת חשבונות – הכנסות';
          mainSubtitle.textContent = '';
          break;
        case 'expenses':
          mainTitle.textContent = 'הנהלת חשבונות – הוצאות';
          mainSubtitle.textContent = '';
          break;
        case 'payroll':
          mainTitle.textContent = 'שכר';
          mainSubtitle.textContent = 'מודול שכר מפורט ייבנה בהמשך';
          break;
        case 'tasks':
          mainTitle.textContent = 'משימות';
          mainSubtitle.textContent = '';
          break;
        case 'products':
          mainTitle.textContent = 'מוצרים / מלאי';
          mainSubtitle.textContent = '';
          break;
        case 'sales':
          mainTitle.textContent = 'ניהול מכירות (שיחות)';
          mainSubtitle.textContent = '';
          break;
        case 'automations':
          mainTitle.textContent = 'אוטומציות';
          mainSubtitle.textContent = '';
          break;
        case 'settings':
          mainTitle.textContent = 'הגדרות והרשאות';
          mainSubtitle.textContent = '';
          break;
      }
    }

    navItems.forEach((item) => {
      item.addEventListener('click', () => {
        const section = item.getAttribute('data-section');
        showSection(section);
      });
    });

    async function api(path, options = {}) {
      const headers = options.headers || {};
      headers['Content-Type'] = 'application/json';
      if (token) {
        headers['Authorization'] = 'Bearer ' + token;
      }
      const res = await fetch(apiBase + path, {
        ...options,
        headers,
      });
      if (!res.ok) {
        let msg = 'שגיאה בשרת';
        try {
          const data = await res.json();
          if (data.message) msg = data.message;
        } catch (e) {}
        throw new Error(msg);
      }
      return res.json();
    }

    // Login

    loginBtn.addEventListener('click', async () => {
      loginError.textContent = '';
      try {
        const data = await api('/api/login', {
          method: 'POST',
          body: JSON.stringify({
            email: loginEmail.value,
            password: loginPassword.value,
          }),
        });
        token = data.token;
        currentUser = data.user;

        loginWrapper.style.display = 'none';
        appLayout.style.display = 'flex';

        sidebarUser.textContent =
          currentUser.name + ' (' + (currentUser.role || '') + ')';

        showSection('dashboard');
      } catch (err) {
        loginError.textContent = err.message;
      }
    });

    // Dashboard data

    const dashNewLeadsEl = document.getElementById('dash-new-leads');
    const dashNewLeadsSubEl = document.getElementById('dash-new-leads-sub');
    const dashIncomeEl = document.getElementById('dash-income');
    const dashIncomeSubEl = document.getElementById('dash-income-sub');
    const dashConversionEl = document.getElementById('dash-conversion');
    const dashConversionSubEl = document.getElementById('dash-conversion-sub');
    const dashHotLeadsEl = document.getElementById('dash-hot-leads');
    const dashTasksListEl = document.getElementById('dash-tasks-list');

    async function loadDashboard() {
      try {
        const customers = await api('/api/customers');
        let payments = [];
        try {
          payments = await api('/api/payments');
        } catch (err) {
          payments = [];
        }

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];

        const newLeadsToday = customers.filter((c) => {
          if (c.status !== 'LEAD') return false;
          if (!c.createdAt) return false;
          return c.createdAt.startsWith(todayStr);
        });

        dashNewLeadsEl.textContent = newLeadsToday.length;
        dashNewLeadsSubEl.textContent =
          newLeadsToday.length > 0
            ? 'לידים חדשים שנכנסו היום למערכת'
            : 'אין לידים חדשים שמסומנים להיום';

        const thisMonth = today.getMonth();
        const thisYear = today.getFullYear();
        const incomesThisMonth = payments.filter((p) => {
          if (!p.date) return false;
          const d = new Date(p.date);
          return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
        });

        const sumIncome = incomesThisMonth.reduce(
          (acc, p) => acc + (p.amount || 0),
          0
        );
        dashIncomeEl.textContent = sumIncome.toLocaleString('he-IL', {
          maximumFractionDigits: 0,
        });
        dashIncomeSubEl.textContent =
          incomesThisMonth.length > 0
            ? 'מספר עסקאות: ' + incomesThisMonth.length
            : 'עדיין אין תשלומים חודשיים במערכת';

        const leadsCount = customers.filter((c) => c.status === 'LEAD').length;
        const activeCount = customers.filter(
          (c) => c.status === 'ACTIVE'
        ).length;
        let conversion = 0;
        const base = leadsCount + activeCount;
        if (base > 0) {
          conversion = Math.round((activeCount / base) * 100);
        }
        dashConversionEl.textContent = conversion + '%';
        dashConversionSubEl.textContent =
          'מתוך ' +
          base +
          ' לידים / לקוחות – ' +
          activeCount +
          ' מוגדרים כלקוחות פעילים.';

        const nowMs = today.getTime();
        const hotLeads = customers.filter((c) => {
          if (c.status !== 'LEAD') return false;
          if (!c.createdAt) return false;
          const d = new Date(c.createdAt);
          const diffHours = (nowMs - d.getTime()) / (1000 * 60 * 60);
          return diffHours <= 48;
        });

        if (hotLeads.length === 0) {
          dashHotLeadsEl.textContent = 'אין כרגע לידים חמים לפי 48 שעות אחרונות.';
        } else {
          dashHotLeadsEl.innerHTML =
            '<ul style="padding-right: 18px; margin: 0;">' +
            hotLeads
              .map((c) => {
                const phone = c.phone || '';
                const src = c.source || '';
                return (
                  '<li style="margin-bottom: 4px;">' +
                  (c.name || '(ללא שם)') +
                  ' – ' +
                  phone +
                  (src ? ' (' + src + ')' : '') +
                  '</li>'
                );
              })
              .join('') +
            '</ul>';
        }

        dashTasksListEl.textContent =
          'חיבור למשימות מתוך /api/tasks יגיע בשלב הבא. כרגע זה דשבורד ללקוחות והכנסות בלבד.';
      } catch (err) {
        dashNewLeadsSubEl.textContent = 'שגיאה בטעינת נתוני דשבורד.';
      }
    }

    // Leads

    const leadsTableBody = document.getElementById('leads-table-body');
    const leadsSearchInput = document.getElementById('leads-search');
    const leadsSearchBtn = document.getElementById('leads-search-btn');
    const leadNameInput = document.getElementById('lead-name');
    const leadPhoneInput = document.getElementById('lead-phone');
    const leadEmailInput = document.getElementById('lead-email');
    const leadSourceInput = document.getElementById('lead-source');
    const leadNotesInput = document.getElementById('lead-notes');
    const leadSaveBtn = document.getElementById('lead-save-btn');
    const leadSaveMsg = document.getElementById('lead-save-msg');

    async function loadLeads(searchTerm) {
      try {
        let url = '/api/customers?status=LEAD';
        if (searchTerm) {
          url += '&q=' + encodeURIComponent(searchTerm);
        }
        const leads = await api(url);
        leadsTableBody.innerHTML = '';
        if (leads.length === 0) {
          leadsTableBody.innerHTML =
            '<tr><td colspan="4" class="small-text">אין לידים להצגה.</td></tr>';
          return;
        }
        leads.forEach((c) => {
          const tr = document.createElement('tr');
          const statusClass = 'status-lead';
          tr.innerHTML =
            '<td>' +
            (c.name || '(ללא שם)') +
            '</td>' +
            '<td>' +
            (c.phone || '') +
            '</td>' +
            '<td><span class="tag ' +
            statusClass +
            '">LEAD</span></td>' +
            '<td>' +
            (c.source || '') +
            '</td>';
          leadsTableBody.appendChild(tr);
        });
      } catch (err) {
        leadsTableBody.innerHTML =
          '<tr><td colspan="4" class="small-text">שגיאה בטעינת לידים.</td></tr>';
      }
    }

    leadsSearchBtn.addEventListener('click', () => {
      loadLeads(leadsSearchInput.value);
    });

    leadSaveBtn.addEventListener('click', async () => {
      leadSaveMsg.textContent = '';
      const name = leadNameInput.value.trim();
      const phone = leadPhoneInput.value.trim();
      const email = leadEmailInput.value.trim();
      const source = leadSourceInput.value.trim();
      const notes = leadNotesInput.value.trim();

      if (!name || !phone) {
        leadSaveMsg.textContent = 'חובה למלא לפחות שם וטלפון.';
        return;
      }

      try {
        const newLead = await api('/api/customers', {
          method: 'POST',
          body: JSON.stringify({
            name,
            phone,
            email,
            source,
            notes,
            status: 'LEAD',
          }),
        });
        leadSaveMsg.textContent = 'ליד נשמר בהצלחה (ID: ' + newLead.id + ')';
        leadNameInput.value = '';
        leadPhoneInput.value = '';
        leadEmailInput.value = '';
        leadSourceInput.value = '';
        leadNotesInput.value = '';
        loadLeads();
        loadDashboard();
      } catch (err) {
        leadSaveMsg.textContent = err.message;
      }
    });

    // Customers

    const customersTableBody = document.getElementById('customers-table-body');
    const customersSearchInput = document.getElementById('customers-search');
    const customersSearchBtn = document.getElementById('customers-search-btn');

    async function loadCustomers(searchTerm) {
      try {
        let url = '/api/customers?status=ACTIVE';
        if (searchTerm) {
          url += '&q=' + encodeURIComponent(searchTerm);
        }
        const customers = await api(url);
        customersTableBody.innerHTML = '';
        if (customers.length === 0) {
          customersTableBody.innerHTML =
            '<tr><td colspan="4" class="small-text">אין לקוחות פעילים להצגה.</td></tr>';
          return;
        }
        customers.forEach((c) => {
          let statusClass = 'status-active';
          let statusLabel = c.status || 'ACTIVE';
          if (c.status === 'INACTIVE') {
            statusClass = 'status-inactive';
          }
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' +
            (c.name || '(ללא שם)') +
            '</td>' +
            '<td>' +
            (c.phone || '') +
            '</td>' +
            '<td>' +
            (c.email || '') +
            '</td>' +
            '<td><span class="tag ' +
            statusClass +
            '">' +
            statusLabel +
            '</span></td>';
          customersTableBody.appendChild(tr);
        });
      } catch (err) {
        customersTableBody.innerHTML =
          '<tr><td colspan="4" class="small-text">שגיאה בטעינת לקוחות.</td></tr>';
      }
    }

    customersSearchBtn.addEventListener('click', () => {
      loadCustomers(customersSearchInput.value);
    });
  </script>
</body>
</html>
